name: Test Reports

on:
  push

jobs:
  allure-report:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v3
        with:
          ref: gh-pages

      - name: Download results from other repository
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh run download -p "allure-*" -R dholth/conda-package-handling 3300350049

      - name: Unpack test results
        run: |
          ls
          # strip the existing allure-results/ embedded in the .tar.gz
          find -name allure-\*.tar.gz -exec tar -xf {} --strip-components=1 \;

      - uses: actions/setup-java@v3
        with:
          # Don't know which Java is the best.
          distribution: 'temurin'
          java-version: '17'

      - run: |
          curl -L -O https://github.com/allure-framework/allure2/releases/download/2.20.0/allure-2.20.0.tgz
          tar -xf allure-2.20.0.tgz

      - name: Make report
        run: |
          ./allure-2.20.0/bin/allure generate --clean

      - name: List everything
        run: ls -R

      # https://lannonbr.com/blog/2019-12-09-git-commit-in-actions/
      - name: setup git config
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "<>"

      - name: commit
        run: |
          # Stage the file, commit and push
          git add allure-report
          git commit -m "reports"
          git push origin gh-pages